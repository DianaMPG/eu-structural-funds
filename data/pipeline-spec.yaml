concatenate_datasets:

  pipeline:

    - run: collect_all_sources

    - run: downloader

    - run: concat
      parameters:
        resource-name: eu-esif-funds-beneficiaries-2007-2020
        column-aliases:
          beneficiary_name: []

          funding_period_number: []
          cci_program_code: []
          project_name: []

          total_amount: []

          starting_date: []

          beneficiary_country_code: []
          beneficiary_nuts_code: []
          fund_name: []

    - run: metadata
      parameters:
        metadata:
          name: eu-esif-funds-beneficiaries-2007-2020
          title: European ESIF Funds Beneficiaries 2000-2020
          description: >
            Structural and Cohesion Funds are financial tools set up to
            implement the regional policy of the European Union. They aim to reduce
            regional disparities in income wealth and opportunities. The overall budget
            for the 2007-2013 period was â‚¬347 billion according to Wikipedia. This
            repository is a data pipeline. It channels information about the beneficiaries
            of the funds into the Open-Spending datastore. The goal is to provide a
            unified dataset that is easy to visualize and query so that citizens and
            journalists can follow the money on a local and global scale. This project
            is a collaborative effort between Open-Knowledge Germany Open-Knowledge
            International and a number of journalists and developers.
          sources:
            - name: Inforegio EU Regional Policy Portal
              web: http://ec.europa.eu/regional_policy/en/
            - name: EU ESIF Portal
              web: https://www.fi-compass.eu/esif/european-structural-and-investment-funds-esif
          author: Loic Jounot <loic@cyberpunk.bike>
          contributors:
            - Bela Seeger <bela.seeger@okfn.de>
            - Anna Alberts <anna.alberts@okfn.de>
          regionCode: eu
          fiscalPeriod:
            start: '2000-01-01'
            stop: '2020-12-31'

    - run: fiscal.model
      parameters:
        options:
          total_amount:
            currency: EUR
        os-types:
          beneficiary_name: recipient:generic:name

          funding_period_number: activity:generic:program:code
          cci_program_code: activity:generic:project:code:full
          project_name: activity:generic:subproject:code:full

          total_amount: value

          starting_date: date:generic

          beneficiary_country_code: administrative-classification:generic:level1:code
          beneficiary_nuts_code: administrative-classification:generic:level2:code:full
          fund_name: fin-source:generic:code


    - run: dump
      validate: true
      parameters:
        out-file: fiscal.datapackage.zip

    - run: fiscal.upload
      parameters:
        in-file: fiscal.datapackage.zip

  schedule: {crontab: 0 0 1 1 *}

